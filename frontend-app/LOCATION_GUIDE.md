# 定位功能使用说明

## 功能概述

社区推荐页面新增了位置获取功能，用户可以在发布烧烤店推荐时自动获取当前位置，为其他用户提供准确的地理位置参考。

## 主要功能

### 1. 自动定位
- 点击"获取当前位置"按钮自动获取GPS坐标
- 自动转换坐标为详细地址信息
- 支持重新定位功能

### 2. 权限管理
- 首次使用时申请位置权限
- 权限被拒绝时引导用户前往设置开启
- 智能处理各种权限状态

### 3. 错误处理
- 定位失败时提供重试功能
- 网络错误、超时等异常情况的友好提示
- 地址解析失败时显示坐标信息

## 使用方法

### 发布推荐时使用定位

1. 进入社区推荐页面
2. 填写基本店铺信息
3. 在"当前位置"区域点击"获取当前位置"
4. 首次使用时授权位置权限
5. 等待定位完成，查看获取到的地址
6. 如需重新定位，点击"重新定位"按钮
7. 提交表单时位置信息会一同提交

### 权限授权

- **首次授权**: 系统会弹窗申请位置权限，点击"允许"即可
- **权限被拒绝**: 如果之前拒绝过权限，系统会提示前往设置开启
- **开启步骤**: 小程序设置 → 位置信息 → 开启

## 技术实现

### 组件架构

```
src/components/LocationPicker/     # 定位选择器组件
├── index.tsx                      # 主组件文件
├── index.scss                     # 样式文件
└── types.ts                       # 类型定义

src/utils/location.ts              # 位置服务工具类
src/config/constants.ts            # 配置常量
```

### 关键API

- `Taro.authorize()` - 申请位置权限
- `Taro.getLocation()` - 获取GPS坐标
- `Taro.getSetting()` - 检查权限状态
- `腾讯地图API` - 逆地理编码服务

### 数据流向

1. 用户点击定位按钮
2. 检查并申请位置权限
3. 调用GPS获取坐标
4. 调用地图API获取地址
5. 更新组件状态
6. 回调通知父组件

## 配置说明

### 必需配置

1. **腾讯地图API密钥**
   - 在 `src/config/constants.ts` 中配置
   - 需要在腾讯地图开放平台申请
   ```typescript
   TENCENT_MAP: {
     KEY: 'YOUR_ACTUAL_API_KEY', // 替换为实际密钥
     BASE_URL: 'https://apis.map.qq.com/ws'
   }
   ```

2. **小程序后台配置**
   - 服务器域名 → request合法域名
   - 添加: `https://apis.map.qq.com`

3. **隐私设置**
   - 小程序后台 → 开发管理 → 开发设置 → 隐私设置
   - 添加API: getLocation

### 权限声明

在 `app.config.ts` 中已配置：

```typescript
permission: {
  "scope.userLocation": {
    desc: "您的位置信息将用于为您推荐附近的烧烤店"
  }
},
requiredPrivateInfos: [
  "getLocation"
]
```

## 使用注意事项

### 开发环境

1. **开发者工具**: 需要在工具中开启位置模拟
2. **真机测试**: 建议在真机上测试定位功能
3. **网络环境**: 确保能访问腾讯地图API

### 生产环境

1. **API密钥**: 确保使用正式的腾讯地图API密钥
2. **域名配置**: 正确配置小程序后台的合法域名
3. **隐私政策**: 确保隐私政策中说明位置信息使用目的

### 用户体验

1. **权限说明**: 向用户清楚说明位置权限的用途
2. **降级处理**: 定位失败时仍可手动输入地址
3. **性能优化**: 避免频繁定位，合理使用缓存

## 常见问题

### Q: 定位一直失败怎么办？
A: 
1. 检查是否授权了位置权限
2. 确认GPS开关是否打开
3. 检查网络连接是否正常
4. 尝试重启小程序或重新授权

### Q: 地址信息不准确？
A: 
1. GPS精度受环境影响，室内可能不准确
2. 可以使用"重新定位"功能
3. 用户可以手动修正地址信息

### Q: 权限被拒绝后如何重新开启？
A: 
1. 删除小程序重新进入
2. 或者：我 → 设置 → 隐私设置 → 位置权限

## 后续扩展

- [ ] 地图选点功能
- [ ] 历史位置记录
- [ ] POI搜索功能
- [ ] 附近推荐优化算法
