# 社区页面定位功能需求

## 需求概述
在社区推荐页面的发布表单中添加"当前位置"字段，允许用户获取并选择自己的地理位置信息，以便为其他用户提供准确的位置参考。

## 功能说明

### 1. 功能入口
- **位置**: 社区推荐发布表单中，在"地址位置"字段下方
- **展示**: 添加"当前位置"表单项，包含定位按钮和位置显示区域
- **原型参考**: `.github/feature_prompts/images/location.png`

### 2. 核心功能

#### 2.1 定位授权
- 首次使用时弹出位置授权提示弹窗
- 用户可选择"允许"或"拒绝"定位权限
- 授权状态需要本地缓存，避免重复询问

#### 2.2 位置获取
- 点击"获取当前位置"按钮触发定位
- 使用微信小程序的 `wx.getLocation` API 获取经纬度
- 调用地图服务API（如腾讯地图）进行逆地理编码，获取详细地址
- 展示加载状态，提供良好的用户反馈

#### 2.3 位置展示
- 成功定位后显示详细地址信息
- 格式：`当前位置：北京市朝阳区三里屯街道`
- 提供"重新定位"按钮，允许用户更新位置
- 定位失败时显示错误提示和重试按钮

### 3. 数据处理

#### 3.1 前端数据结构
```typescript
interface LocationData {
  latitude: number      // 纬度
  longitude: number     // 经度
  address: string       // 详细地址
  isLocationEnabled: boolean  // 是否已获取位置
}

// 扩展现有表单数据结构
interface PostFormData {
  shop_name: string
  shop_location: string
  shop_price: string
  comment: string
  // 新增位置字段
  latitude?: number
  longitude?: number
  location_address?: string
}
```

#### 3.2 后端数据存储
- 后端已支持 `latitude`、`longitude`、`location_address` 字段
- 前端提交时包含这些字段到API请求中
- 用于后续的"附近推荐"功能

### 4. 用户体验设计

#### 4.1 交互流程
1. 用户进入发布表单页面
2. 填写基本信息（店铺名称、地址位置等）
3. 看到"当前位置"表单项，点击"获取当前位置"按钮
4. 首次使用弹出授权弹窗，用户选择授权
5. 开始定位，显示loading状态
6. 定位成功后显示地址，用户可选择使用或重新定位
7. 提交表单时包含位置信息

#### 4.2 错误处理
- **授权被拒绝**: 显示提示引导用户手动输入位置或前往设置开启权限
- **定位失败**: 显示网络错误或GPS信号弱提示，提供重试按钮
- **地址解析失败**: 显示经纬度信息，提示用户手动完善地址

### 5. 实现要点

#### 5.1 技术方案
- 使用 `Taro.getLocation()` 获取GPS坐标
- 集成腾讯地图API进行地址解析
- 使用 `Taro.authorize()` 处理权限申请
- 创建可复用的定位组件 `LocationPicker`

#### 5.2 关键API
```typescript
// 定位相关API
Taro.authorize({ scope: 'scope.userLocation' })
Taro.getLocation({ type: 'gcj02' })

// 调用腾讯地图逆地理编码API
// https://apis.map.qq.com/ws/geocoder/v1/
```

#### 5.3 组件设计
创建独立的定位选择组件：
```
src/components/LocationPicker/
├── index.tsx           # 主组件
├── index.scss          # 样式文件
└── types.ts           # 类型定义
```

### 6. 开发任务分解

#### 6.1 前端任务
1. 创建定位权限授权弹窗组件
2. 创建位置选择器组件 `LocationPicker`
3. 集成腾讯地图逆地理编码服务
4. 修改社区表单，添加位置字段
5. 更新表单提交逻辑，包含位置数据
6. 添加相关错误处理和用户提示

#### 6.2 后端验证
1. 确认API接口已支持位置字段（已完成）
2. 验证位置数据存储和检索功能
3. 测试"附近推荐"相关接口

### 7. 验收标准

#### 7.1 功能验收
- [ ] 用户可以成功获取当前位置
- [ ] 位置信息准确显示在表单中
- [ ] 表单提交包含完整的位置数据
- [ ] 权限拒绝和定位失败有合适的降级处理
- [ ] 定位组件可复用于其他页面

#### 7.2 体验验收
- [ ] 定位过程有清晰的loading状态
- [ ] 权限申请流程用户友好
- [ ] 错误提示信息明确且有指导性
- [ ] 整体交互流畅，无卡顿现象

### 8. 后续扩展

#### 8.1 高级功能
- 地图选点功能，允许用户在地图上手动选择位置
- 历史位置记录，快速选择常用位置
- 位置搜索功能，支持POI搜索

#### 8.2 数据利用
- 基于位置的个性化推荐
- 区域热门店铺统计
- 用户活动轨迹分析

## 技术注意事项

1. **隐私保护**: 严格按照微信小程序隐私政策处理位置信息
2. **性能优化**: 合理缓存地理编码结果，避免重复请求
3. **兼容性**: 考虑不同设备的GPS精度差异
4. **用户体验**: 提供清晰的权限说明和操作指引